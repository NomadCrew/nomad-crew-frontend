# Plan 01-02: Supabase Storage Bucket Setup

**Phase:** 1 - Foundation
**Plan:** 01-02
**Status:** Ready for execution

## Goal

Create and configure the `wallet-documents` Supabase Storage bucket with folder-based organization and RLS policies that enforce privacy between personal and group documents.

## Context

From research (01-RESEARCH.md):
- Private bucket (not public) for security
- Folder structure: `personal/{user_id}/` and `trips/{trip_id}/`
- RLS on `storage.objects` table controls access
- Uses `storage.foldername()` helper to extract path components

Existing patterns (INTEGRATIONS.md):
- Supabase already integrated with `@supabase/supabase-js` 2.86
- Auth uses Supabase Auth with JWT tokens
- `auth.uid()` available in RLS policies

## Tasks

### Task 1: Create wallet-documents storage bucket

**What:** Create a private storage bucket for wallet documents

**File:** `.planning/phases/01-foundation/migrations/004_storage_bucket.sql`

**Implementation:**
```sql
-- Migration: 004_storage_bucket.sql
-- Purpose: Create private storage bucket for wallet documents

-- Create the bucket
INSERT INTO storage.buckets (id, name, public, file_size_limit, allowed_mime_types)
VALUES (
  'wallet-documents',
  'wallet-documents',
  false,  -- Private bucket
  10485760,  -- 10MB limit per file
  ARRAY[
    'application/pdf',
    'image/jpeg',
    'image/png',
    'image/heic',
    'image/heif',
    'image/webp'
  ]
)
ON CONFLICT (id) DO UPDATE SET
  public = EXCLUDED.public,
  file_size_limit = EXCLUDED.file_size_limit,
  allowed_mime_types = EXCLUDED.allowed_mime_types;

-- Add comment for documentation
COMMENT ON TABLE storage.buckets IS 'wallet-documents: Private bucket for personal and group travel documents';
```

**Bucket configuration:**
| Setting | Value | Reason |
|---------|-------|--------|
| public | false | All access through signed URLs or RLS |
| file_size_limit | 10MB | Sufficient for PDFs/photos, prevents abuse |
| allowed_mime_types | PDF, images | Travel docs are PDFs or scanned images |

**Why this approach:**
- Private bucket requires authentication for all access
- File size limit prevents storage abuse
- MIME type restrictions ensure only valid document types
- ON CONFLICT allows re-running migration safely

**Verification:**
- [ ] Bucket appears in Supabase Storage dashboard
- [ ] Bucket marked as private
- [ ] Attempting to upload 15MB file fails
- [ ] Attempting to upload .exe file fails

---

### Task 2: Create storage RLS policies for personal documents

**What:** Define RLS policies on storage.objects for personal document folders

**File:** `.planning/phases/01-foundation/migrations/005_storage_rls_personal.sql`

**Implementation:**
```sql
-- Migration: 005_storage_rls_personal.sql
-- Purpose: RLS policies for personal document storage access

-- Personal documents: Full access for owner
-- Path format: personal/{user_id}/{filename}

-- SELECT policy - view/download personal files
CREATE POLICY "Users can view their personal documents"
ON storage.objects FOR SELECT
USING (
  bucket_id = 'wallet-documents' AND
  (storage.foldername(name))[1] = 'personal' AND
  (storage.foldername(name))[2] = auth.uid()::text
);

-- INSERT policy - upload personal files
CREATE POLICY "Users can upload personal documents"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'wallet-documents' AND
  (storage.foldername(name))[1] = 'personal' AND
  (storage.foldername(name))[2] = auth.uid()::text
);

-- UPDATE policy - update personal files (replace)
CREATE POLICY "Users can update their personal documents"
ON storage.objects FOR UPDATE
USING (
  bucket_id = 'wallet-documents' AND
  (storage.foldername(name))[1] = 'personal' AND
  (storage.foldername(name))[2] = auth.uid()::text
)
WITH CHECK (
  bucket_id = 'wallet-documents' AND
  (storage.foldername(name))[1] = 'personal' AND
  (storage.foldername(name))[2] = auth.uid()::text
);

-- DELETE policy - remove personal files
CREATE POLICY "Users can delete their personal documents"
ON storage.objects FOR DELETE
USING (
  bucket_id = 'wallet-documents' AND
  (storage.foldername(name))[1] = 'personal' AND
  (storage.foldername(name))[2] = auth.uid()::text
);
```

**Path validation explained:**
- `storage.foldername(name)` returns array of path segments
- `[1]` = first folder level (e.g., "personal")
- `[2]` = second folder level (e.g., user_id)
- Cast `auth.uid()` to text for comparison

**Why this approach:**
- Separate policies for each operation for clarity
- Path-based access control is simple and robust
- No joins needed - just string comparison
- User ID in path matches authenticated user

**Verification:**
- [ ] User can upload to `personal/{own_user_id}/test.pdf`
- [ ] User cannot upload to `personal/{other_user_id}/test.pdf`
- [ ] User cannot upload to `personal/` (missing user_id folder)
- [ ] User cannot list other users' personal folders

---

### Task 3: Create storage RLS policies for group documents

**What:** Define RLS policies on storage.objects for trip group document folders

**File:** `.planning/phases/01-foundation/migrations/006_storage_rls_group.sql`

**Implementation:**
```sql
-- Migration: 006_storage_rls_group.sql
-- Purpose: RLS policies for group document storage access

-- Group documents: Access for trip members
-- Path format: trips/{trip_id}/{filename}

-- SELECT policy - trip members can view group files
CREATE POLICY "Trip members can view group documents"
ON storage.objects FOR SELECT
USING (
  bucket_id = 'wallet-documents' AND
  (storage.foldername(name))[1] = 'trips' AND
  (storage.foldername(name))[2]::uuid IN (SELECT get_user_trip_ids(auth.uid()))
);

-- INSERT policy - trip members can upload group files
CREATE POLICY "Trip members can upload group documents"
ON storage.objects FOR INSERT
WITH CHECK (
  bucket_id = 'wallet-documents' AND
  (storage.foldername(name))[1] = 'trips' AND
  (storage.foldername(name))[2]::uuid IN (SELECT get_user_trip_ids(auth.uid()))
);

-- UPDATE policy - only file owner can update
-- Note: This requires checking owner metadata or allowing all members
-- For simplicity, allow any trip member to update (collaborative model)
CREATE POLICY "Trip members can update group documents"
ON storage.objects FOR UPDATE
USING (
  bucket_id = 'wallet-documents' AND
  (storage.foldername(name))[1] = 'trips' AND
  (storage.foldername(name))[2]::uuid IN (SELECT get_user_trip_ids(auth.uid()))
)
WITH CHECK (
  bucket_id = 'wallet-documents' AND
  (storage.foldername(name))[1] = 'trips' AND
  (storage.foldername(name))[2]::uuid IN (SELECT get_user_trip_ids(auth.uid()))
);

-- DELETE policy - trip members can delete group files
-- Note: Consider restricting to uploader only in production
CREATE POLICY "Trip members can delete group documents"
ON storage.objects FOR DELETE
USING (
  bucket_id = 'wallet-documents' AND
  (storage.foldername(name))[1] = 'trips' AND
  (storage.foldername(name))[2]::uuid IN (SELECT get_user_trip_ids(auth.uid()))
);
```

**Design decision: Collaborative vs Owner-only**

For group documents, two models are possible:
1. **Collaborative (implemented):** Any trip member can modify/delete any group document
2. **Owner-only:** Only uploader can modify/delete

Chose collaborative for v1 because:
- Simpler to implement
- Matches "shared folder" mental model
- Document metadata table tracks ownership for audit
- Can add stricter controls later if needed

**Why this approach:**
- Uses security definer function to check membership
- Casts path segment to UUID for proper comparison
- Consistent with database RLS policies
- All trip members have equal access to group storage

**Verification:**
- [ ] Trip member can upload to `trips/{trip_id}/test.pdf`
- [ ] Non-member cannot upload to `trips/{trip_id}/test.pdf`
- [ ] Trip member can list files in `trips/{trip_id}/`
- [ ] Non-member cannot list files in `trips/{trip_id}/`

---

## Dependencies

- **Requires:** Plan 01-01 (needs `get_user_trip_ids` function)
- **Blocks:** Plan 02-01 (Upload service needs storage bucket)

## Acceptance Criteria

1. `wallet-documents` bucket exists and is private
2. Personal folder access restricted to document owner
3. Group folder access restricted to trip members
4. File size and MIME type restrictions enforced
5. All operations (SELECT, INSERT, UPDATE, DELETE) have appropriate policies

## Folder Structure Reference

```
wallet-documents/
├── personal/
│   ├── {user_id_1}/
│   │   ├── {doc_id_1}.pdf
│   │   └── {doc_id_2}.jpg
│   └── {user_id_2}/
│       └── {doc_id_3}.pdf
└── trips/
    ├── {trip_id_1}/
    │   ├── {doc_id_4}.pdf
    │   └── {doc_id_5}.jpg
    └── {trip_id_2}/
        └── {doc_id_6}.pdf
```

## Notes

- **Testing:** Use Supabase dashboard to test uploads with different user tokens
- **Cleanup:** Consider adding lifecycle rules for old documents in production
- **Monitoring:** Enable storage analytics to track usage patterns

---

*Plan created: 2026-01-10*
*Ready for execution*
