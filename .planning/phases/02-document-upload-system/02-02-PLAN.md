---
phase: 02-document-upload-system
plan: 02
type: execute
---

<objective>
Connect upload services to Zustand store and create React hooks for document upload workflow.

Purpose: Wire the service layer to state management, providing a clean API for UI components to use.
Output: Implemented store actions and React hooks for document CRUD and upload operations.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-phase.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-document-upload-system/02-RESEARCH.md

**Prior plan in this phase:**
@.planning/phases/02-document-upload-system/02-01-SUMMARY.md

**Phase 1 context:**
@.planning/phases/01-foundation/SUMMARY-01-03.md

**Existing code:**
@src/features/wallet/types.ts
@src/features/wallet/store.ts
@src/features/wallet/adapters/normalizeDocument.ts
@src/api/supabase.ts

**From Plan 02-01:**
- Services at src/features/wallet/services/
- documentPicker, imageCompressor, storageUpload

**Established patterns:**
- Zustand stores with devtools middleware (existing pattern)
- Feature-based hooks in hooks/ directory
- Logger integration via @/src/utils/logger
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement store CRUD actions</name>
  <files>src/features/wallet/store.ts</files>
  <action>
Update the Zustand store to implement the placeholder CRUD actions:

1. Import services:
   ```typescript
   import {
     uploadDocument as uploadToStorage,
     getSignedUrl,
     deleteDocument as deleteFromStorage,
     generateStoragePath,
     STORAGE_BUCKET,
     MAX_FILE_SIZE,
     compressImage,
     shouldCompress,
   } from './services';
   import { normalizeDocument, normalizeDocuments } from './adapters/normalizeDocument';
   import { supabase } from '@/src/api/supabase';
   ```

2. Implement `fetchPersonalDocuments`:
   - Query `wallet_documents` table with `wallet_type: 'personal'`
   - Filter by `user_id` (from auth)
   - Apply optional filters (documentType, search)
   - Use `normalizeDocuments()` on response
   - Update `personalDocuments` state

3. Implement `fetchGroupDocuments`:
   - Query `wallet_documents` table with `wallet_type: 'group'` and `trip_id`
   - Apply optional filters
   - Use `normalizeDocuments()` on response
   - Update `groupDocuments[tripId]` state

4. Implement `createDocument`:
   - Validate file size against MAX_FILE_SIZE
   - Get current user from `supabase.auth.getUser()`
   - Compress image if `shouldCompress(mimeType)`
   - Generate storage path with `generateStoragePath()`
   - Upload file with `uploadToStorage()`
   - Insert record into `wallet_documents` table
   - Normalize and add to appropriate documents array
   - Return created document

5. Implement `deleteDocument`:
   - Get document from state
   - Delete from storage with `deleteFromStorage()`
   - Delete from `wallet_documents` table
   - Remove from state

6. Implement `uploadDocument` (full flow):
   - Same as createDocument but with progress state updates
   - Set `uploadProgress: 0` at start
   - Set `uploadProgress: 30` after compression
   - Set `uploadProgress: 70` after storage upload
   - Set `uploadProgress: 100` after DB insert
   - Clear progress on complete/error

**Do NOT:**
- Skip file size validation (bucket rejects >10MB)
- Forget to normalize backend responses
- Leave placeholder throws in implemented actions
- Skip compression for images (wastes bandwidth)
  </action>
  <verify>
Run type check: `npx tsc --noEmit src/features/wallet/store.ts 2>&1 | head -30`
  </verify>
  <done>
- fetchPersonalDocuments queries Supabase and updates state
- fetchGroupDocuments queries Supabase and updates state
- createDocument handles full upload flow (compress, upload, insert)
- deleteDocument removes from storage and database
- uploadDocument provides progress tracking
- All actions properly handle errors and update loading/error state
  </done>
</task>

<task type="auto">
  <name>Task 2: Create upload hooks for UI consumption</name>
  <files>src/features/wallet/hooks/useDocumentUpload.ts, src/features/wallet/hooks/useDocumentPicker.ts, src/features/wallet/hooks/index.ts</files>
  <action>
Create document picker hook at `src/features/wallet/hooks/useDocumentPicker.ts`:

```typescript
import { useState, useCallback } from 'react';
import { pickImage, pickDocument, takePhoto, PickedFile } from '../services';

export function useDocumentPicker() {
  const [isPickerOpen, setIsPickerOpen] = useState(false);

  const pick = useCallback(async (
    type: 'image' | 'document' | 'camera'
  ): Promise<PickedFile | null> => {
    setIsPickerOpen(true);
    try {
      switch (type) {
        case 'image':
          return await pickImage();
        case 'document':
          return await pickDocument();
        case 'camera':
          return await takePhoto();
        default:
          return null;
      }
    } finally {
      setIsPickerOpen(false);
    }
  }, []);

  return { pick, isPickerOpen };
}
```

Create document upload hook at `src/features/wallet/hooks/useDocumentUpload.ts`:

```typescript
import { useCallback } from 'react';
import { useWalletStore } from '../store';
import { CreateDocumentInput } from '../types';
import { PickedFile } from '../services';

export function useDocumentUpload() {
  const uploadDocument = useWalletStore((state) => state.uploadDocument);
  const uploadProgress = useWalletStore((state) => state.uploadProgress);
  const uploadError = useWalletStore((state) => state.uploadError);
  const clearError = useWalletStore((state) => state.clearError);

  const upload = useCallback(async (
    file: PickedFile,
    metadata: Omit<CreateDocumentInput, 'fileUri' | 'mimeType'>
  ) => {
    const input: CreateDocumentInput = {
      ...metadata,
      fileUri: file.uri,
      mimeType: file.mimeType,
    };
    return uploadDocument(input);
  }, [uploadDocument]);

  return {
    upload,
    progress: uploadProgress,
    error: uploadError,
    clearError,
    isUploading: uploadProgress !== null,
  };
}
```

Update `src/features/wallet/hooks/index.ts`:
- Export useDocumentPicker
- Export useDocumentUpload
- Re-export selector hooks from store (usePersonalDocuments, etc.)

**Do NOT:**
- Put business logic in hooks (keep in store)
- Create circular dependencies between hooks and store
- Forget to handle the isPickerOpen loading state
  </action>
  <verify>
Run type check: `npx tsc --noEmit src/features/wallet/hooks/*.ts 2>&1 | head -30`
  </verify>
  <done>
- useDocumentPicker hook with pick(type) and isPickerOpen state
- useDocumentUpload hook with upload(), progress, error, isUploading
- hooks/index.ts exports all hooks
- No TypeScript errors
- Clean separation of concerns (hooks are thin wrappers)
  </done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] `npx tsc --noEmit` passes for store.ts and all hooks
- [ ] Store actions implement full flow (not placeholders)
- [ ] Hooks provide clean API for UI consumption
- [ ] Error handling in place for all operations
</verification>

<success_criteria>

- Store CRUD actions fully implemented (not throwing "Not implemented")
- fetchPersonalDocuments, fetchGroupDocuments query Supabase
- createDocument handles compression + storage upload + DB insert
- deleteDocument removes from storage and database
- uploadDocument provides progress tracking via state
- useDocumentPicker and useDocumentUpload hooks created
- All exports available from hooks/index.ts
- No TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-document-upload-system/02-02-SUMMARY.md` following summary.md template.

Include:
- Store actions implemented
- Hooks created
- Any integration patterns established
- Ready for Plan 02-03 (UI components)
</output>
